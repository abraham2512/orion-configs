# PTP Change Point Detection Orion Configuration
# Author: Carlos Cardenosa (@ccardenosa), Abraham Miller (@abraham2512)ÃŸ
# Date: Feb 3, 2026
# FIXED: Updated to match actual OpenSearch data structure
#
# OpenSearch Index: svc_telco_ptp
#
# Metrics tracked:
#   - ptp4l: Master clock offset (hardware timestamping)
#   - phc2sys: System clock to PHC synchronization
#
# Threshold Analysis (Dec 23, 2025 - 4 runs):
#   PTP4L:
#     - Baseline max: ~23 ns (average across runs)
#     - Natural variation: ~22% (range: 21-26 ns)
#     - Recommended threshold: 30%
#   PHC2SYS:
#     - Baseline max: ~59 ns (average across runs)
#     - Natural variation: ~29% (range: 52-69 ns)
#     - Recommended threshold: 35%
#
# Note: PTP is much more stable than CPU-util, so thresholds are tighter.

tests:
  # PTP4L Metrics - Master offset measurements
  - name: telco-ptp-ptp4l-offset
    version_field: tags.sw_version
    metadata:
      tags.sw_version: "4.21*"
      # tags.cluster: "spree*"  # Uncomment to filter by cluster prefix

    metrics:
      # Maximum ptp4l offset - critical for worst-case synchronization
      # Baseline: ~23 ns, Natural variation: 22%, Alert if > 30% increase
      - name: ptp4l_max_offset
        resource_type: ptp4l
        component: max
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1  # Higher offset is worse
        threshold: 30  # Based on 4-run analysis: 22% natural variation + margin

      # Minimum ptp4l offset (absolute value)
      # Baseline: ~24 ns, Natural variation: similar to max
      - name: ptp4l_min_offset
        resource_type: ptp4l
        component: min
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1
        threshold: 30

      # Average ptp4l offset - overall synchronization quality
      # Baseline: ~0 ns (very centered), low variance
      - name: ptp4l_avg_offset
        resource_type: ptp4l
        component: avg
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1
        threshold: 30

  # PHC2SYS Metrics - System clock synchronization
  - name: telco-ptp-phc2sys-offset
    version_field: tags.sw_version
    metadata:
      tags.sw_version: "4.21*"

    metrics:
      # Maximum phc2sys offset
      # Baseline: ~59 ns, Natural variation: 29%, Alert if > 80 ns
      - name: phc2sys_max_offset
        resource_type: phc2sys
        component: max
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1
        threshold: 35  # Based on 4-run analysis: 29% natural variation + margin

      # Minimum phc2sys offset
      - name: phc2sys_min_offset
        resource_type: phc2sys
        component: min
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1
        threshold: 35

      # Average phc2sys offset
      # Baseline: ~11 ns average
      - name: phc2sys_avg_offset
        resource_type: phc2sys
        component: avg
        test_phase: offset
        result_type: ""
        metric_of_interest: value
        direction: 1
        threshold: 35
